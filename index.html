<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA GESTÃƒO - XKmix</title>
    <style>
        :root { --roxo: #4b2c71; --laranja: #e67e22; --verde: #25D366; --vermelho: #ff4757; }
        body { font-family: sans-serif; background: var(--roxo); margin: 0; color: #333; }
        
        /* UI */
        .header { text-align: center; padding: 20px; color: white; }
        .logo { width: 80px; height: 80px; background: white; border-radius: 15px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; border: 3px solid var(--laranja); }
        .logo img { width: 90%; }
        
        .container { max-width: 500px; margin: auto; padding: 10px; padding-bottom: 120px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        
        h2 { font-size: 14px; color: var(--roxo); border-bottom: 2px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; }
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        
        /* BotÃµes */
        .btn-add { background: var(--laranja); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-del { color: var(--vermelho); background: none; border: none; font-size: 20px; cursor: pointer; font-weight: bold; }
        .footer { position: fixed; bottom: 0; width: 100%; background: var(--roxo); padding: 15px; box-sizing: border-box; border-top: 2px solid var(--laranja); text-align: center; }
        .btn-zap { background: var(--verde); color: white; border: none; width: 100%; max-width: 400px; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        /* Login */
        #login { position: fixed; inset: 0; background: var(--roxo); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .box { background: white; padding: 30px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="login">
    <div class="box">
        <div class="logo"><img src="https://i.ibb.co/XrnM3fPj/image.png"></div>
        <h3>XKMIX GESTÃƒO</h3>
        <select id="loja">
            <option value="pdp">Loja PDP</option>
            <option value="cdv">Loja CDV</option>
            <option value="tjcpp">Loja TJCPP</option>
            <option value="goiana">Loja GOIANA</option>
            <option value="adm">ADM (KÃ¡tia/Victor)</option>
        </select>
        <input type="password" id="senha" placeholder="Senha">
        <button class="btn-zap" style="background:var(--laranja)" onclick="logar()">ENTRAR</button>
    </div>
</div>

<div class="header">
    <div class="logo"><img src="https://i.ibb.co/XrnM3fPj/image.png"></div>
    <small id="user-info"></small>
</div>

<div class="container">
    <div class="card">
        <input type="number" id="zap" placeholder="WhatsApp p/ Envio (Ex: 55819...)" style="margin:0;">
    </div>
    <div id="app"></div>
</div>

<div class="footer">
    <button class="btn-zap" onclick="enviar()">ðŸš€ ENVIAR PEDIDO WHATSAPP</button>
</div>

<script>
    const URL = "https://sistema-xkmix-default-rtdb.firebaseio.com/dados.json";
    let db = { "SORVETES": ["Abacaxi", "Morango"], "COMPLEMENTOS": ["Granola"] };
    let user = "";

    async function carregar() {
        try {
            const r = await fetch(URL);
            const data = await r.json();
            if (data) db = data;
            render();
        } catch (e) {
            console.log("Erro ao carregar, usando backup local.");
            render();
        }
    }

    async function salvar() {
        render(); // Atualiza a tela primeiro
        try {
            await fetch(URL, { method: 'PUT', body: JSON.stringify(db) });
        } catch (e) { alert("Erro ao salvar na nuvem!"); }
    }

    function render() {
        const app = document.getElementById('app');
        app.innerHTML = '';
        const marcados = JSON.parse(localStorage.getItem('marcados_'+user) || "[]");

        for (let cat in db) {
            let h = `<div class="card"><h2>${cat} <button class="btn-add" onclick="add('${cat}')">+ ADD</button></h2>`;
            db[cat].forEach(item => {
                const isCheck = marcados.includes(item) ? 'checked' : '';
                h += `<div class="item-row">
                    <label style="flex:1; cursor:pointer;"><input type="checkbox" onchange="marcar('${item}')" ${isCheck}> ${item}</label>
                    <button class="btn-del" onclick="del('${cat}','${item}')">Ã—</button>
                </div>`;
            });
            app.innerHTML += h + `</div>`;
        }
    }

    function add(cat) {
        const nome = prompt("Nome do item:");
        if (nome) { db[cat].push(nome); salvar(); }
    }

    function del(cat, item) {
        if (confirm(`Remover ${item}?`)) {
            db[cat] = db[cat].filter(i => i !== item);
            salvar();
        }
    }

    function marcar(item) {
        let m = JSON.parse(localStorage.getItem('marcados_'+user) || "[]");
        m = m.includes(item) ? m.filter(x => x !== item) : [...m, item];
        localStorage.setItem('marcados_'+user, JSON.stringify(m));
    }

    function enviar() {
        const m = JSON.parse(localStorage.getItem('marcados_'+user) || "[]");
        const fone = document.getElementById('zap').value;
        if (!fone || m.length === 0) return alert("Selecione itens e o WhatsApp!");

        let txt = `*ðŸ“¦ PEDIDO XKMIX - ${user.toUpperCase()}*\n\n`;
        m.forEach(i => txt += `â€¢ ${i}\n`);
        
        window.open(`https://wa.me/${fone}?text=${encodeURIComponent(txt)}`);
    }

    function logar() {
        const s = document.getElementById('senha').value;
        if (s !== "") {
            user = document.getElementById('loja').value;
            document.getElementById('login').style.display = 'none';
            document.getElementById('user-info').innerText = "Loja: " + user.toUpperCase();
            document.getElementById('zap').value = localStorage.getItem('zap_global') || "";
            carregar();
        }
    }

    document.getElementById('zap').onchange = (e) => localStorage.setItem('zap_global', e.target.value);
</script>
</body>
</html>
