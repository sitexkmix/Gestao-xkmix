<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA GEST√ÉO CLOUD - XKmix</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --roxo-fundo: #4b2c71; 
            --roxo-card: #ffffff;
            --laranja: #e67e22;
            --verde-zap: #25D366;
            --vermelho: #ff4757;
            --azul-adm: #2e86de;
        }
        body { font-family: sans-serif; background-color: var(--roxo-fundo); margin: 0; padding: 0; color: #333; overflow-x: hidden; }
        
        /* Menu Lateral */
        #menu-lateral { height: 100%; width: 0; position: fixed; z-index: 1000; top: 0; left: 0; background-color: #f8f9fa; overflow-x: hidden; transition: 0.3s; padding-top: 60px; box-shadow: 2px 0 10px rgba(0,0,0,0.3); }
        #menu-lateral a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: var(--roxo-fundo); display: block; border-bottom: 1px solid #ddd; font-weight: bold; }
        .btn-menu { font-size: 30px; cursor: pointer; color: white; position: fixed; top: 15px; left: 15px; z-index: 900; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 0 10px; }

        /* Login */
        #tela-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--roxo-fundo); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-box select, .login-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-entrar { background: var(--laranja); color: white; border: none; width: 100%; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }

        /* Interface Principal */
        #conteudo-sistema { display: none; }
        .header { text-align: center; padding: 20px 15px 10px; }
        .logo-container { width: 100px; height: 100px; margin: 0 auto; background: #fff; border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 3px solid var(--laranja); overflow: hidden; }
        .logo-container img { width: 100%; height: 100%; object-fit: contain; }
        .container { max-width: 500px; margin: auto; padding: 15px; padding-bottom: 220px; }
        .info-sessao { background: rgba(255,255,255,0.1); color: white; text-align: center; padding: 5px; font-size: 11px; margin-bottom: 10px; border-radius: 5px; }

        /* Cards de Categoria */
        .categoria-card { background: var(--roxo-card); border-radius: 12px; margin-bottom: 15px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        h2 { color: var(--roxo-fundo); font-size: 14px; border-bottom: 2px solid #eee; margin: 0 0 10px 0; padding-bottom: 5px; text-transform: uppercase; }
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f2f2f2; }
        
        /* Controles de Estoque */
        .estoque-controles { display: flex; align-items: center; gap: 8px; }
        .btn-qtd { background: #eee; border: none; width: 30px; height: 30px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .qtd-num { font-weight: bold; min-width: 25px; text-align: center; }
        .sem-estoque { color: var(--vermelho); text-decoration: line-through; opacity: 0.5; }

        /* Lixeiras e Adi√ß√£o */
        .btn-lixeira { background: none; border: none; cursor: pointer; font-size: 18px; padding-left: 10px; }
        .campo-add-cat { display: flex; gap: 5px; margin-top: 12px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .campo-add-cat input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; }
        .btn-add-plus { background: var(--roxo-fundo); color: white; border: none; padding: 0 12px; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* Rodap√© */
        .footer-fixed { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--roxo-fundo); padding: 10px; box-sizing: border-box; z-index: 800; border-top: 2px solid var(--laranja); }
        .btn-whatsapp { background: var(--verde-zap); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        .pedido-historico { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--laranja); position: relative; font-size: 13px; }
        .btn-del-hist { position: absolute; top: 10px; right: 10px; color: var(--vermelho); border: none; background: none; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="tela-login">
    <div class="header"><div class="logo-container"><img src="https://i.postimg.cc/vBf5rMQc/F3F489B5-7AC2-4DA8-94C8-D819346C6836.png"></div></div>
    <div class="login-box">
        <h3>SISTEMA XKMIX CLOUD</h3>
        <select id="local-login">
            <option value="pdp">Loja PDP</option>
            <option value="cdv">Loja CDV</option>
            <option value="tjcpp">Loja TJCPP</option>
            <option value="goiana">Loja GOIANA</option>
            <option value="expresso">Loja EXPRESSO</option>
            <option value="adm">Administrador (ADM)</option>
        </select>
        <input type="text" id="user" placeholder="Usu√°rio">
        <input type="password" id="pass" placeholder="Senha">
        <button class="btn-entrar" onclick="verificarLogin()">ENTRAR</button>
        <p id="erro" style="color:red; font-size:12px; display:none; margin-top:10px;">Login incorreto!</p>
    </div>
</div>

<div id="conteudo-sistema">
    <div id="menu-lateral">
        <a href="javascript:void(0)" onclick="toggleMenu(0)" style="font-size:30px;">&times;</a>
        <a href="#" onclick="showView('pedido'); toggleMenu(0)">üìù Fazer Pedido</a>
        <a href="#" onclick="showView('estoque'); toggleMenu(0)">üì¶ Estoque Online</a>
        <a href="#" onclick="showView('historico'); toggleMenu(0)">üìÖ Hist√≥rico Central</a>
        <hr>
        <a href="#" onclick="logout()" style="color:var(--vermelho);">‚ûî SAIR</a>
    </div>

    <span class="btn-menu" onclick="toggleMenu(250)">&#9776;</span>
    <div class="header"><div class="logo-container"><img src="https://i.postimg.cc/vBf5rMQc/F3F489B5-7AC2-4DA8-94C8-D819346C6836.png"></div></div>
    <div class="info-sessao" id="status-sessao"></div>

    <div class="container">
        <div id="view-pedido">
            <div style="background:white; padding:10px; border-radius:10px; margin-bottom:15px; border:2px solid var(--laranja);">
                <input type="number" id="zap-destino" placeholder="WhatsApp (Ex: 55819...)" onchange="salvarZap(this.value)" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;">
            </div>
            <div id="app-pedidos">Carregando itens...</div>
        </div>

        <div id="view-estoque" style="display:none;">
            <h2 style="color:white; border:none;">Controle de Estoque</h2>
            <div id="app-estoque">Carregando estoque...</div>
        </div>

        <div id="view-historico" style="display:none;">
            <h2 style="color:white; border:none;">Registro de Atividades</h2>
            <div id="lista-historico"></div>
        </div>
    </div>

    <div class="footer-fixed" id="footer-pedido">
        <button class="btn-whatsapp" onclick="enviarWhatsApp()">üöÄ ENVIAR PEDIDO</button>
        <button onclick="limparMarcacoes()" style="background:none; border:none; color:white; width:100%; margin-top:8px; font-size:11px; text-decoration:underline;">Limpar sele√ß√£o</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAH5egfaSGzr74JGZB-Wzii1VdkC1UiFKk",
        authDomain: "sistema-xkmix.firebaseapp.com",
        projectId: "sistema-xkmix",
        storageBucket: "sistema-xkmix.firebasestorage.app",
        messagingSenderId: "1096205200442",
        appId: "1:1096205200442:web:491c0f7b57bd7599f71903",
        databaseURL: "https://sistema-xkmix-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // LISTA ORIGINAL DE ITENS (Fallback)
    const ITENS_PADRAO = {
        "SORVETES / A√áA√çS": ["Abacaxi", "Abacaxi ao vinho", "A√ßa√≠", "A√ßa√≠ c/ ninho", "Bananinha", "Base baulinha", "Base ninho", "Blue ice", "Caipirinha", "Canjica", "Cereja", "Choco menta", "Chocolate", "Cupua√ßu", "Diamante Negro", "Ferrero rocher", "Frutas vermelhas", "Kiwi", "Lim√£o", "Ma√ß√£ verde", "Maracuj√°", "Morango", "Ninho com nutella", "Nutella", "Oreo", "Ovomaltine", "Pa√ßoca", "Passas ao rum", "Pistache", "Prest√≠gio"],
        "COMPLEMENTOS": ["Amendoim", "Balafini amora", "Balafini azedinha", "Balafini bananinha", "Balafini beijinho", "Balafini colorida", "Canudo waffer", "Choco ball", "Farinha l√°ctea", "Gotas de chocolate", "Granola", "Granulado", "Granulado colorido", "Jujuba", "Leite condensado", "Mashwmallow", "MM", "Ovinho de amendoim", "Ovomaltine", "Pa√ßoca"],
        "CREMES": ["Amarena", "Avel√£", "Avel√£ essencial", "Choco trufa", "Coco", "Cookies", "Doce de leite", "Geleia de morango", "Laka", "Leitinho", "Leitinho crocante", "Oreo", "Ovomaltine", "Skimo", "Sonho de valsa"],
        "EMBALAGENS / DESCART√ÅVEIS": ["Base flurry", "Base mr 300 ml", "Base mr 500 ml", "Copo 180 ml", "Copo 300 ml", "Copo 330 ml", "Copo 440 ml-milkshake", "Copo 500 ml", "Guardanapo copo", "Guardanapos mesa", "Kraft G", "Kraft M", "Kraft P", "Kraft PP", "Papel inter-folhas", "Sacola de lixo 50L", "Sacola de lixo 100L", "Sacola G", "Sacola M", "Sacola P", "Sacola PPP", "Tampa 300 ml", "Tampa 500 ml", "Tampa bolha", "Tampa flurry", "Tampa mr 300 ml", "Tampa mr 500 ml"],
        "BEBIDAS": ["√Ågua mineral", "√Ågua mineral com g√°s", "Coca cola 1L", "Coca cola 250 ml", "Coca cola 250 ml-zero", "Coca cola 500 ml", "Coca cola lata", "Coca cola lata- zero", "Coca cola 500 ml- zero", "Fanta lata", "Guaran√° ant√°rtica 1L", "Guaran√° lata", "H2O", "H2O limoneto", "Monster", "Schweppes lata", "Soda 1L", "Sukita 1L"],
        "MOLHOS": ["Ketchup", "Maionese", "Mostarda"],
        "COBERTURAS": ["Amora", "Blue ice", "Caramelo", "Chiclete", "Chocolate", "Doce de leite", "Fini bananinha", "Fini beijinho", "Fini dentadura", "Maracuj√°", "Morango"],
        "LIMPEZA": ["√Ågua sanit√°ria", "√Ålcool", "Desinfetante", "Detergente", "Pinho-sol", "Sabonete l√≠quido"]
    };

    let localLogado = "";

    function verificarLogin() {
        const local = document.getElementById('local-login').value;
        const u = document.getElementById('user').value.toLowerCase().trim();
        const s = document.getElementById('pass').value.trim();
        const creds = { "pdp":"loja1", "tjcpp":"loja2", "cdv":"loja3", "goiana":"loja4", "expresso":"loja5", "adm":"xkmix2026" };

        if(u === local && s === creds[local]) {
            localLogado = local;
            document.getElementById('tela-login').style.display = 'none';
            document.getElementById('conteudo-sistema').style.display = 'block';
            document.getElementById('status-sessao').innerText = `LOJA ATIVA: ${local.toUpperCase()}`;
            document.getElementById('zap-destino').value = localStorage.getItem(`xkmix_zap_${local}`) || "";
            showView('pedido');
        } else { document.getElementById('erro').style.display = 'block'; }
    }

    // CARREGA E RENDERIZA ITENS
    function renderizar() {
        const app = document.getElementById('app-pedidos');
        db.ref('catalogo').on('value', (snap) => {
            let catalogo = snap.val();
            // Se o banco estiver vazio, carrega os itens padr√£o
            if(!catalogo) {
                db.ref('catalogo').set(ITENS_PADRAO);
                return;
            }
            db.ref(`marcados/${localLogado}`).on('value', (sM) => {
                const marcados = sM.val() || [];
                app.innerHTML = '';
                for(let cat in catalogo) {
                    let h = `<div class="categoria-card"><h2>${cat}</h2>`;
                    catalogo[cat].forEach(item => {
                        const check = marcados.includes(item) ? 'checked' : '';
                        h += `<div class="item-row">
                            <label style="flex:1; display:flex; align-items:center; gap:10px;">
                                <input type="checkbox" onchange="toggleMarcado('${item}')" ${check}>
                                <span>${item}</span>
                            </label>
                            <button class="btn-lixeira" onclick="deletarItem('${cat}', '${item}')">üóëÔ∏è</button>
                        </div>`;
                    });
                    h += `<div class="campo-add-cat">
                        <input type="text" id="in-${cat.replace(/\s/g,'')}" placeholder="Novo item...">
                        <button class="btn-add-plus" onclick="adicionarItem('${cat}')">+</button>
                    </div></div>`;
                    app.innerHTML += h;
                }
            });
        });
    }

    // ESTOQUE FUNCIONANDO
    function renderEstoque() {
        const app = document.getElementById('app-estoque');
        db.ref('catalogo').once('value', (snap) => {
            const catalogo = snap.val() || ITENS_PADRAO;
            db.ref(`estoque/${localLogado}`).on('value', (sE) => {
                const estoque = sE.val() || {};
                app.innerHTML = '';
                for(let cat in catalogo) {
                    let h = `<div class="categoria-card"><h2>${cat}</h2>`;
                    catalogo[cat].forEach(item => {
                        let qtd = estoque[item] || 0;
                        h += `<div class="item-row">
                            <span class="${qtd <= 0 ? 'sem-estoque' : ''}">${item}</span>
                            <div class="estoque-controles">
                                <button class="btn-qtd" onclick="altEstoque('${item}', -1)">-</button>
                                <span class="qtd-num">${qtd}</span>
                                <button class="btn-qtd" onclick="altEstoque('${item}', 1)">+</button>
                            </div>
                        </div>`;
                    });
                    app.innerHTML += h + `</div>`;
                }
            });
        });
    }

    function altEstoque(item, v) {
        const ref = db.ref(`estoque/${localLogado}/${item}`);
        ref.transaction(c => {
            let n = (c || 0) + v;
            return n < 0 ? 0 : n;
        });
    }

    function adicionarItem(cat) {
        const id = `in-${cat.replace(/\s/g,'')}`;
        const nome = document.getElementById(id).value.trim();
        if(!nome) return;
        db.ref(`catalogo/${cat}`).once('value', s => {
            let lista = s.val() || [];
            if(!lista.includes(nome)) {
                lista.push(nome);
                db.ref(`catalogo/${cat}`).set(lista).then(() => document.getElementById(id).value = '');
            }
        });
    }

    function deletarItem(cat, item) {
        if(confirm(`Remover ${item}?`)) {
            db.ref(`catalogo/${cat}`).once('value', s => {
                let lista = s.val() || [];
                db.ref(`catalogo/${cat}`).set(lista.filter(i => i !== item));
            });
        }
    }

    function toggleMarcado(item) {
        const ref = db.ref(`marcados/${localLogado}`);
        ref.once('value', s => {
            let m = s.val() || [];
            m = m.includes(item) ? m.filter(x => x !== item) : [...m, item];
            ref.set(m);
        });
    }

    function renderHistorico() {
        const d = document.getElementById('lista-historico');
        db.ref(`historico/${localLogado}`).on('value', (snapshot) => {
            const hist = snapshot.val() || [];
            d.innerHTML = hist.length ? '' : `<p style="color:white;text-align:center;">Vazio.</p>`;
            hist.forEach((p, idx) => {
                d.innerHTML += `<div class="pedido-historico"><button class="btn-del-hist" onclick="delHist(${idx})">√ó</button><b>${p.data}</b><br><small style="white-space:pre-wrap;">${p.texto}</small></div>`;
            });
        });
    }

    function delHist(idx) {
        db.ref(`historico/${localLogado}`).once('value', s => {
            let h = s.val() || []; h.splice(idx, 1);
            db.ref(`historico/${localLogado}`).set(h);
        });
    }

    function showView(v) {
        document.getElementById('view-pedido').style.display = v === 'pedido' ? 'block' : 'none';
        document.getElementById('footer-pedido').style.display = v === 'pedido' ? 'block' : 'none';
        document.getElementById('view-estoque').style.display = v === 'estoque' ? 'block' : 'none';
        document.getElementById('view-historico').style.display = v === 'historico' ? 'block' : 'none';
        if(v === 'pedido') renderizar(); 
        if(v === 'estoque') renderEstoque();
        if(v === 'historico') renderHistorico();
    }

    function enviarWhatsApp() {
        const zap = document.getElementById('zap-destino').value;
        if(!zap) return alert("N√∫mero!");
        db.ref(`marcados/${localLogado}`).once('value', sM => {
            const m = sM.val() || [];
            db.ref('catalogo').once('value', sC => {
                const conf = sC.val();
                let t = `*üì¶ PEDIDO XKMIX - ${localLogado.toUpperCase()}*\n\n`;
                for(let cat in conf) {
                    const sel = conf[cat].filter(i => m.includes(i));
                    if(sel.length) t += `*${cat}:*\n${sel.map(i => "‚Ä¢ "+i).join('\n')}\n\n`;
                }
                db.ref(`historico/${localLogado}`).once('value', sh => {
                    let h = sh.val() || [];
                    h.unshift({data: new Date().toLocaleString('pt-BR'), texto: t});
                    db.ref(`historico/${localLogado}`).set(h);
                });
                window.open(`https://wa.me/${zap}?text=${encodeURIComponent(t)}`);
            });
        });
    }

    function toggleMenu(s) { document.getElementById("menu-lateral").style.width = s + "px"; }
    function salvarZap(v) { localStorage.setItem(`xkmix_zap_${localLogado}`, v); }
    function limparMarcacoes() { if(confirm("Limpar?")) db.ref(`marcados/${localLogado}`).set([]); }
    function logout() { location.reload(); }
</script>
</body>
</html>
