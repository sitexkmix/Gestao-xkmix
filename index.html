<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA GEST√ÉO - XKmix</title>
    <style>
        :root {
            --roxo-fundo: #4b2c71; 
            --roxo-card: #ffffff;
            --laranja: #e67e22;
            --verde-zap: #25D366;
            --vermelho: #ff4757;
            --azul-adm: #2e86de;
        }
        body { font-family: sans-serif; background-color: var(--roxo-fundo); margin: 0; padding: 0; color: #333; overflow-x: hidden; }
        
        /* Menu Lateral */
        #menu-lateral { height: 100%; width: 0; position: fixed; z-index: 1000; top: 0; left: 0; background-color: #f8f9fa; overflow-x: hidden; transition: 0.3s; padding-top: 60px; box-shadow: 2px 0 10px rgba(0,0,0,0.3); }
        #menu-lateral a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: var(--roxo-fundo); display: block; border-bottom: 1px solid #ddd; font-weight: bold; }
        .btn-menu { font-size: 30px; cursor: pointer; color: white; position: fixed; top: 15px; left: 15px; z-index: 900; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 0 10px; }

        /* Login */
        #tela-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--roxo-fundo); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-box select, .login-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-entrar { background: var(--laranja); color: white; border: none; width: 100%; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }

        /* Interface Principal */
        #conteudo-sistema { display: none; }
        .header { text-align: center; padding: 20px 15px 10px; }
        .logo-container { width: 120px; height: 120px; margin: 0 auto; background: #fff; border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 3px solid var(--laranja); overflow: hidden; }
        .logo-container img { width: 100%; height: 100%; object-fit: contain; }
        .container { max-width: 500px; margin: auto; padding: 15px; padding-bottom: 220px; }
        .info-sessao { background: rgba(255,255,255,0.1); color: white; text-align: center; padding: 5px; font-size: 11px; margin-bottom: 10px; border-radius: 5px; }

        /* Busca */
        .busca-container { margin-bottom: 15px; padding: 0 15px; }
        .busca-container input { width: 100%; padding: 12px; border-radius: 10px; border: none; box-sizing: border-box; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Cards */
        .categoria-card { background: var(--roxo-card); border-radius: 12px; margin-bottom: 15px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        h2 { color: var(--roxo-fundo); font-size: 15px; border-bottom: 2px solid #eee; margin: 0 0 10px 0; padding-bottom: 5px; text-transform: uppercase; }
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f2f2f2; }
        
        .estoque-controles { display: flex; align-items: center; gap: 10px; }
        .btn-qtd { background: #eee; border: none; width: 32px; height: 32px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .qtd-num { font-weight: bold; min-width: 30px; text-align: center; }
        .sem-estoque { color: var(--vermelho); text-decoration: line-through; opacity: 0.6; }

        .filtro-adm { background: white; padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 2px solid var(--laranja); }
        .filtro-adm select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }

        .footer-fixed { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--roxo-fundo); padding: 10px; box-sizing: border-box; z-index: 800; border-top: 2px solid var(--laranja); }
        .btn-whatsapp { background: var(--verde-zap); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; font-size: 16px; cursor: pointer; }
        
        .pedido-historico { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--laranja); position: relative; }
        .btn-del-hist { position: absolute; top: 10px; right: 10px; color: var(--vermelho); border: none; background: none; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="tela-login">
    <div class="header"><div class="logo-container"><img src="https://i.ibb.co/XrnM3fPj/image.png"></div></div>
    <div class="login-box">
        <h3>ACESSO XKMIX</h3>
        <select id="local-login">
            <option value="pdp">Loja PDP</option>
            <option value="cdv">Loja CDV</option>
            <option value="tjcpp">Loja TJCPP</option>
            <option value="goiana">Loja GOIANA</option>
            <option value="expresso">Loja EXPRESSO</option>
            <option value="adm">Login ADM</option>
        </select>
        <input type="text" id="user" placeholder="Usu√°rio" autocapitalize="none">
        <input type="password" id="pass" placeholder="Senha">
        <button class="btn-entrar" onclick="verificarLogin()">ENTRAR</button>
        <p id="erro" style="color:red; font-size:12px; display:none; margin-top:10px;">Dados incorretos!</p>
    </div>
</div>

<div id="conteudo-sistema">
    <div id="menu-lateral">
        <a href="javascript:void(0)" onclick="toggleMenu(0)" style="font-size:30px;">&times;</a>
        <a href="#" onclick="showView('pedido'); toggleMenu(0)">üìù Fazer Pedido</a>
        <a href="#" onclick="showView('estoque'); toggleMenu(0)">üì¶ Estoque</a>
        <a href="#" onclick="showView('historico'); toggleMenu(0)">üìÖ Hist√≥rico</a>
        <hr>
        <a href="#" onclick="logout()" style="color:var(--vermelho);">‚ûî SAIR DO SISTEMA</a>
    </div>

    <span class="btn-menu" onclick="toggleMenu(250)">&#9776;</span>
    <div class="header"><div class="logo-container"><img src="https://i.ibb.co/XrnM3fPj/image.png"></div></div>
    <div class="info-sessao" id="status-sessao"></div>

    <div class="container">
        <div class="busca-container">
            <input type="text" id="inputBusca" placeholder="üîç Buscar item..." onkeyup="filtrarItens()">
        </div>

        <div id="view-pedido">
            <div class="filtro-adm"><input type="number" id="zap-destino" placeholder="WhatsApp para envio (Ex: 55819...)" onchange="salvarZap(this.value)"></div>
            <div id="app-pedidos"></div>
        </div>

        <div id="view-estoque" style="display:none;">
            <div id="filtro-estoque-adm" class="filtro-adm" style="display:none;">
                <label style="font-size:10px; font-weight:bold;">LOJA SELECIONADA:</label>
                <select id="select-estoque-adm" onchange="renderEstoque()"></select>
            </div>
            <div id="app-estoque"></div>
        </div>
        
        <div id="view-historico" style="display:none;">
            <div id="filtro-hist-adm" class="filtro-adm" style="display:none;">
                <select id="select-loja-adm" onchange="renderHistorico()"></select>
            </div>
            <div id="lista-historico"></div>
        </div>
    </div>

    <div class="footer-fixed" id="footer-pedido">
        <button class="btn-whatsapp" onclick="enviarWhatsApp()">üöÄ ENVIAR PEDIDO VIA WHATSAPP</button>
        <button onclick="limparMarcacoes()" style="background:none; border:none; color:white; width:100%; margin-top:8px; font-size:11px; text-decoration:underline; cursor:pointer;">Desmarcar todos os itens</button>
    </div>
</div>

<script>
    const DB_URL = "https://sistema-xkmix-default-rtdb.firebaseio.com/";
    const LOJAS = ["pdp", "tjcpp", "cdv", "goiana", "expresso"];
    const CREDENCIAIS = {
        "pdp": {user: "pdp", pass: "loja1"}, "tjcpp": {user: "tjcpp", pass: "loja2"},
        "cdv": {user: "cdv", pass: "loja3"}, "goiana": {user: "goiana", pass: "loja4"},
        "expresso": {user: "expresso", pass: "loja5"}, "adm": {user: "adm", pass: "xkmix2026"}
    };

    let localLogado = "";
    let database = {
        "SORVETES / A√áA√çS": ["Abacaxi", "Abacaxi ao vinho", "A√ßa√≠", "A√ßa√≠ c/ ninho", "Bananinha", "Base baulinha", "Base ninho", "Blue ice", "Caipirinha", "Canjica", "Cereja", "Choco menta", "Chocolate", "Cupua√ßu", "Diamante Negro", "Ferrero rocher", "Frutas vermelhas", "Kiwi", "Lim√£o", "Ma√ß√£ verde", "Maracuj√°", "Morango", "Ninho com nutella", "Nutella", "Oreo", "Ovomaltine", "Pa√ßoca", "Passas ao rum", "Pistache", "Prest√≠gio"],
        "COMPLEMENTOS": ["Amendoim", "Balafini amora", "Balafini azedinha", "Balafini bananinha", "Balafini beijinho", "Balafini colorida", "Canudo waffer", "Choco ball", "Farinha l√°ctea", "Gotas de chocolate", "Granola", "Granulado", "Granulado colorido", "Jujuba", "Leite condensado", "Mashwmallow", "MM", "Ovinho de amendoim", "Ovomaltine", "Pa√ßoca"],
        "CREMES": ["Amarena", "Avel√£", "Avel√£ essencial", "Choco trufa", "Coco", "Cookies", "Doce de leite", "Geleia de morango", "Laka", "Leitinho", "Leitinho crocante", "Oreo", "Ovomaltine", "Skimo", "Sonho de valsa"],
        "EMBALAGENS / DESCART√ÅVEIS": ["Base flurry", "Base mr 300 ml", "Base mr 500 ml", "Copo 180 ml", "Copo 300 ml", "Copo 330 ml", "Copo 440 ml-milkshake", "Copo 500 ml", "Guardanapo copo", "Guardanapos mesa", "Kraft G", "Kraft M", "Kraft P", "Kraft PP", "Papel inter-folhas", "Sacola de lixo 50L", "Sacola de lixo 100L", "Sacola G", "Sacola M", "Sacola P", "Sacola PPP", "Tampa 300 ml", "Tampa 500 ml", "Tampa bolha", "Tampa flurry", "Tampa mr 300 ml", "Tampa mr 500 ml"],
        "BEBIDAS": ["√Ågua mineral", "√Ågua mineral com g√°s", "Coca cola 1L", "Coca cola 250 ml", "Coca cola 250 ml-zero", "Coca cola 500 ml", "Coca cola lata", "Coca cola lata- zero", "Coca cola 500 ml- zero", "Fanta lata", "Guaran√° ant√°rtica 1L", "Guaran√° lata", "H2O", "H2O limoneto", "Monster", "Schweppes lata", "Soda 1L", "Sukita 1L"],
        "MOLHOS": ["Ketchup", "Maionese", "Mostarda"],
        "COBERTURAS": ["Amora", "Blue ice", "Caramelo", "Chiclete", "Chocolate", "Doce de leite", "Fini bananinha", "Fini beijinho", "Fini dentadura", "Maracuj√°", "Morango"],
        "LIMPEZA": ["√Ågua sanit√°ria", "√Ålcool", "Desinfetante", "Detergente", "Pinho-sol", "Sabonete l√≠quido"]
    };

    async function salvarBD(caminho, dados) {
        await fetch(`${DB_URL}${caminho}.json`, { method: 'PUT', body: JSON.stringify(dados) });
    }

    async function buscarBD(caminho) {
        const response = await fetch(`${DB_URL}${caminho}.json`);
        return await response.json();
    }

    function verificarLogin() {
        const local = document.getElementById('local-login').value;
        const u = document.getElementById('user').value.toLowerCase().trim();
        const s = document.getElementById('pass').value.trim();
        const cred = CREDENCIAIS[local];

        if(cred && u === cred.user && s === cred.pass) {
            localLogado = local;
            document.getElementById('tela-login').style.display = 'none';
            document.getElementById('conteudo-sistema').style.display = 'block';
            document.getElementById('status-sessao').innerText = `CONECTADO: ${local.toUpperCase()}`;
            
            if(local === 'adm') {
                preencherSelectsAdm();
                document.getElementById('filtro-hist-adm').style.display = 'block';
                document.getElementById('filtro-estoque-adm').style.display = 'block';
            }
            showView('pedido');
        } else {
            document.getElementById('erro').style.display = 'block';
        }
    }

    function preencherSelectsAdm() {
        const opts = LOJAS.map(l => `<option value="${l}">Loja ${l.toUpperCase()}</option>`).join('');
        document.getElementById('select-loja-adm').innerHTML = opts;
        document.getElementById('select-estoque-adm').innerHTML = opts;
    }

    // --- VIEW PEDIDO ---
    function renderPedido() {
        const app = document.getElementById('app-pedidos'); app.innerHTML = '';
        const marcados = JSON.parse(localStorage.getItem(`xkmix_marcados_${localLogado}`) || "[]");
        
        for (let cat in database) {
            let h = `<div class="categoria-card"><h2>${cat}</h2>`;
            database[cat].forEach(item => {
                const isChecked = marcados.includes(item) ? 'checked' : '';
                h += `<div class="item-row item-busca">
                        <label style="display:flex;align-items:center;gap:10px;flex:1;cursor:pointer;">
                            <input type="checkbox" class="check-item" value="${item}" onchange="alternarMarca('${item}')" ${isChecked} style="width:22px;height:22px;">
                            <span>${item}</span>
                        </label>
                      </div>`;
            });
            app.innerHTML += h + `</div>`;
        }
    }

    function alternarMarca(item) {
        let m = JSON.parse(localStorage.getItem(`xkmix_marcados_${localLogado}`) || "[]");
        if(m.includes(item)) m = m.filter(x => x !== item);
        else m.push(item);
        localStorage.setItem(`xkmix_marcados_${localLogado}`, JSON.stringify(m));
    }

    function limparMarcacoes() {
        if(confirm("Deseja desmarcar todos os itens?")) {
            localStorage.removeItem(`xkmix_marcados_${localLogado}`);
            renderPedido();
        }
    }

    async function enviarWhatsApp() {
        const m = JSON.parse(localStorage.getItem(`xkmix_marcados_${localLogado}`) || "[]");
        const zap = document.getElementById('zap-destino').value;
        
        if(!zap) return alert("Por favor, digite o n√∫mero do WhatsApp de destino.");
        if(m.length === 0) return alert("Selecione pelo menos um item para o pedido.");

        let txt = `*üì¶ PEDIDO XKMIX - ${localLogado.toUpperCase()}*\n\n`;
        for (let cat in database) {
            const itensDaCat = database[cat].filter(i => m.includes(i));
            if(itensDaCat.length > 0) {
                txt += `*${cat}:*\n`;
                itensDaCat.forEach(i => txt += `‚Ä¢ ${i}\n`);
                txt += `\n`;
            }
        }
        
        // Salvar no Hist√≥rico do Firebase
        let h = await buscarBD(`historico/${localLogado}`) || [];
        h.unshift({data: new Date().toLocaleString('pt-BR'), texto: txt});
        await salvarBD(`historico/${localLogado}`, h);
        
        window.open(`https://wa.me/${zap}?text=${encodeURIComponent(txt)}`);
    }

    // --- VIEW ESTOQUE ---
    async function renderEstoque() {
        const app = document.getElementById('app-estoque');
        app.innerHTML = '<p style="text-align:center; color:white;">Carregando...</p>';
        let loja = localLogado === 'adm' ? document.getElementById('select-estoque-adm').value : localLogado;
        let est = await buscarBD(`estoque/${loja}`) || {};
        app.innerHTML = '';
        for (let cat in database) {
            let h = `<div class="categoria-card"><h2>${cat}</h2>`;
            database[cat].forEach(item => {
                let q = est[item] || 0;
                h += `<div class="item-row item-busca">
                        <span class="${q <= 0 ? 'sem-estoque' : ''}">${item}</span>
                        <div class="estoque-controles">
                            <button class="btn-qtd" onclick="altEst('${loja}','${item}',-1)">-</button>
                            <span class="qtd-num">${q}</span>
                            <button class="btn-qtd" onclick="altEst('${loja}','${item}',1)">+</button>
                        </div>
                      </div>`;
            });
            app.innerHTML += h + `</div>`;
        }
    }

    async function altEst(l, i, v) {
        let est = await buscarBD(`estoque/${l}`) || {};
        est[i] = (est[i] || 0) + v; if(est[i]<0) est[i]=0;
        await salvarBD(`estoque/${l}`, est); renderEstoque();
    }

    // --- VIEW HIST√ìRICO ---
    async function renderHistorico() {
        let loja = localLogado === 'adm' ? document.getElementById('select-loja-adm').value : localLogado;
        let hist = await buscarBD(`historico/${loja}`) || [];
        const d = document.getElementById('lista-historico'); d.innerHTML = '';
        
        if(hist.length === 0) d.innerHTML = '<p style="color:white;text-align:center;">Nenhum pedido no hist√≥rico.</p>';
        
        hist.forEach((p, i) => {
            d.innerHTML += `<div class="pedido-historico">
                <button class="btn-del-hist" onclick="delHist('${loja}', ${i})">üóëÔ∏è</button>
                <b>${p.data}</b><br><small style="white-space:pre-wrap;">${p.texto}</small>
            </div>`;
        });
    }

    async function delHist(loja, index) {
        if(confirm("Excluir este pedido do hist√≥rico permanentemente?")) {
            let hist = await buscarBD(`historico/${loja}`) || [];
            hist.splice(index, 1);
            await salvarBD(`historico/${loja}`, hist);
            renderHistorico();
        }
    }

    // --- GERAL ---
    function filtrarItens() {
        let input = document.getElementById('inputBusca').value.toLowerCase();
        let rows = document.querySelectorAll('.item-busca');
        rows.forEach(row => {
            let text = row.innerText.toLowerCase();
            row.style.display = text.includes(input) ? "flex" : "none";
        });
    }

    function showView(v) {
        document.getElementById('view-pedido').style.display = v==='pedido'?'block':'none';
        document.getElementById('view-estoque').style.display = v==='estoque'?'block':'none';
        document.getElementById('view-historico').style.display = v==='historico'?'block':'none';
        document.getElementById('footer-pedido').style.display = v==='pedido'?'block':'none';
        if(v==='pedido') renderPedido(); 
        if(v==='estoque') renderEstoque(); 
        if(v==='historico') renderHistorico();
    }

    function toggleMenu(s) { document.getElementById("menu-lateral").style.width = s + "px"; }
    function logout() { location.reload(); }
    function salvarZap(v) { localStorage.setItem('zap_xkmix', v); }
    window.onload = () => { document.getElementById('zap-destino').value = localStorage.getItem('zap_xkmix') || ""; }
</script>
</body>
</html>
